<link rel="stylesheet" type="text/css" href="vs2015.css"><h1 id="recoil-apollo" tabindex="-1"><a href="https://cr15p1.github.io">recoil-apollo</a></h1>
<p>recoil-apollo is a tool to modify a recoil state using the apollo client based on graphql queries, mutations and subscriptions.</p>
<h2 id="setup" tabindex="-1">Setup</h2>
<h3 id="install" tabindex="-1">Install</h3>
<pre><code class="hljs language-sh"><span class="hljs-comment"># yarn</span>
yarn add recoil-apollo
<span class="hljs-comment"># npm</span>
npm install recoil-apollo

</code></pre>
<h3 id="connect" tabindex="-1">Connect</h3>
<pre><code class="hljs language-ts"><span class="hljs-comment">// App.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-variable constant_">FC</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RecoilRoot</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;recoil&quot;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">RecoilApollo</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;recoil-apollo&quot;</span>;

<span class="hljs-keyword">import</span> <span class="hljs-title class_">Index</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./Index&quot;</span>;
<span class="hljs-keyword">import</span> apolloClient <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./lib/apolloClient&quot;</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">App</span>: <span class="hljs-variable constant_">FC</span> = <span class="hljs-function">() =&gt;</span> (
  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">RecoilRoot</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">RecoilApollo</span> <span class="hljs-attr">client</span>=<span class="hljs-string">{apolloClient}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Index</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">RecoilApollo</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">RecoilRoot</span>&gt;</span></span>
);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;

</code></pre>
<h2 id="usage" tabindex="-1">Usage</h2>
<h3 id="types" tabindex="-1">types</h3>
<pre><code class="hljs language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Message</span> {
  _id?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>;
}

</code></pre>
<h3 id="query" tabindex="-1">Query</h3>
<pre><code class="hljs language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GraphQLQueryEffectOptions</span>&lt;
  <span class="hljs-title class_">TResponse</span> = <span class="hljs-built_in">any</span>,
  <span class="hljs-title class_">TData</span> = <span class="hljs-built_in">any</span>,
  <span class="hljs-title class_">TVariables</span> = <span class="hljs-built_in">any</span>
&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">QueryOptions</span>&lt;<span class="hljs-title class_">TVariables</span>, <span class="hljs-title class_">TResponse</span>&gt;, &quot;variables&quot;&gt; {
  <span class="hljs-attr">query</span>: <span class="hljs-title class_">DocumentNode</span>;
  <span class="hljs-comment">/**
   * M
   * <span class="hljs-doctag">@Returns</span> {<span class="hljs-type">object</span>}
   */</span>
  variables?: <span class="hljs-title class_">TVariables</span>;
  skip?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">effect</span>: <span class="hljs-function">(<span class="hljs-params">data: {
    error?: <span class="hljs-built_in">Error</span>;
    setSelf: SetSelf&lt;TData&gt;;
    response?: ApolloQueryResult&lt;TResponse&gt;;
  }</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}

</code></pre>
<pre><code class="hljs language-ts"><span class="hljs-comment">// queryMessageIds.ts</span>
<span class="hljs-keyword">import</span> { atom } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;recoil&quot;</span>;
<span class="hljs-keyword">import</span> { graphQLQueryEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;recoil-apollo&quot;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TypeDefs</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../TypeDefs&quot;</span>;

<span class="hljs-keyword">const</span> messageIdsAtom = <span class="hljs-title function_">atom</span>({
  <span class="hljs-attr">key</span>: <span class="hljs-string">&quot;messageIds&quot;</span>,
  <span class="hljs-attr">effects</span>: [
    graphQLQueryEffect&lt;{ <span class="hljs-attr">messageIds</span>: <span class="hljs-built_in">string</span>[] }, <span class="hljs-built_in">string</span>[] | <span class="hljs-literal">undefined</span>&gt;({
      <span class="hljs-attr">fetchPolicy</span>: <span class="hljs-string">&quot;no-cache&quot;</span>,
      <span class="hljs-attr">query</span>: <span class="hljs-title class_">TypeDefs</span>.<span class="hljs-property">messageIds</span>,
      <span class="hljs-attr">effect</span>: <span class="hljs-function">(<span class="hljs-params">{ setSelf, response }</span>) =&gt;</span> {
        <span class="hljs-title function_">setSelf</span>(response?.<span class="hljs-property">data</span>.<span class="hljs-property">messageIds</span>);
      },
    }),
  ],
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> messageIdsAtom;

</code></pre>
<h3 id="mutation" tabindex="-1">Mutation</h3>
<pre><code class="hljs language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GraphQLMutationEffectOptions</span>&lt;
  <span class="hljs-title class_">TResponse</span> = <span class="hljs-built_in">any</span>,
  <span class="hljs-title class_">TData</span> = <span class="hljs-built_in">any</span>,
  <span class="hljs-title class_">TVariables</span> = <span class="hljs-built_in">any</span>
&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">MutationOptions</span>&lt;<span class="hljs-title class_">TResponse</span>, <span class="hljs-title class_">TVariables</span>&gt;, &quot;variables&quot; | &quot;mutate&quot;&gt; {
  <span class="hljs-attr">mutation</span>: <span class="hljs-title class_">DocumentNode</span>;
  skip?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">boolean</span>;
  when?: <span class="hljs-function">(<span class="hljs-params">data: {
    newValue?: TData;
    oldValue?: TData;
    isReset: <span class="hljs-built_in">boolean</span>;
  }</span>) =&gt;</span> <span class="hljs-built_in">boolean</span>;
  variables?: <span class="hljs-function">(<span class="hljs-params">data: { newValue?: TData; oldValue?: TData }</span>) =&gt;</span> <span class="hljs-title class_">TVariables</span>;
  <span class="hljs-attr">effect</span>: <span class="hljs-function">(<span class="hljs-params">data: {
    error?: <span class="hljs-built_in">Error</span>;
    refetch: () =&gt; <span class="hljs-built_in">void</span>;
    setSelf: SetSelf&lt;TData&gt;;
    response?: FetchResult&lt;TResponse&gt;;
  }</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}

</code></pre>
<pre><code class="hljs language-ts"><span class="hljs-comment">// createMessage.ts</span>
<span class="hljs-keyword">import</span> { atomFamily } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;recoil&quot;</span>;
<span class="hljs-keyword">import</span> { graphQLMutationEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;recoil-apollo&quot;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TypeDefs</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../TypeDefs&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Message</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../types&quot;</span>;

<span class="hljs-keyword">const</span> createMessageAtomFamily = atomFamily&lt;<span class="hljs-title class_">Message</span>, <span class="hljs-built_in">string</span>&gt;({
  <span class="hljs-attr">key</span>: <span class="hljs-string">&quot;messageIds&quot;</span>,
  <span class="hljs-attr">effects</span>: <span class="hljs-function">() =&gt;</span> [
    <span class="hljs-comment">/**
     * To be able to refetch in `graphQLMutationEffect()`,
     * a `graphQLQueryEffect()` must first be created in the same recoil state.
     */</span>
    graphQLMutationEffect&lt;<span class="hljs-built_in">any</span>, <span class="hljs-title class_">Message</span>&gt;({
      <span class="hljs-attr">mutation</span>: <span class="hljs-title class_">TypeDefs</span>.<span class="hljs-property">createMessage</span>,
      <span class="hljs-attr">variables</span>: <span class="hljs-function">(<span class="hljs-params">{ newValue }</span>) =&gt;</span> ({ <span class="hljs-attr">message</span>: newValue }),
      <span class="hljs-attr">when</span>: <span class="hljs-function">(<span class="hljs-params">{ newValue }</span>) =&gt;</span> <span class="hljs-title class_">Boolean</span>(newValue &amp;&amp; newValue.<span class="hljs-property">_id</span> === <span class="hljs-literal">undefined</span>),
      <span class="hljs-attr">effect</span>: <span class="hljs-function">(<span class="hljs-params">{ refetch }</span>) =&gt;</span> {
        <span class="hljs-title function_">refetch</span>();
      },
    }),
  ],
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> createMessageAtomFamily;

</code></pre>
<h3 id="subscription" tabindex="-1">Subscription</h3>
<pre><code class="hljs language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GraphQLSubscriptionEffectOptions</span>&lt;
  <span class="hljs-title class_">TResponse</span> = <span class="hljs-built_in">any</span>,
  <span class="hljs-title class_">TData</span> = <span class="hljs-built_in">any</span>,
  <span class="hljs-title class_">TVariables</span> = <span class="hljs-built_in">any</span>
&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Omit</span>&lt;
    <span class="hljs-title class_">SubscriptionOptions</span>&lt;<span class="hljs-title class_">TVariables</span>, <span class="hljs-title class_">TResponse</span>&gt;,
    &quot;variables&quot; | &quot;query&quot;
  &gt; {
  <span class="hljs-attr">subscription</span>: <span class="hljs-title class_">DocumentNode</span>;
  variables?: <span class="hljs-function">(<span class="hljs-params">data: { value?: TData }</span>) =&gt;</span> <span class="hljs-title class_">TVariables</span>;
  skip?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">effect</span>: <span class="hljs-function">(<span class="hljs-params">data: {
    errors?: <span class="hljs-keyword">readonly</span> GraphQLError[];
    refetch: () =&gt; <span class="hljs-built_in">void</span>;
    setSelf: SetSelf&lt;TData&gt;;
    response?: FetchResult&lt;TResponse&gt;;
  }</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}

</code></pre>
<pre><code class="hljs language-ts"><span class="hljs-comment">// subscribeMessageIds.ts</span>
<span class="hljs-keyword">import</span> { atom } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;recoil&quot;</span>;
<span class="hljs-keyword">import</span> { graphQLSubscriptionEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;recoil-apollo&quot;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TypeDefs</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../TypeDefs&quot;</span>;

<span class="hljs-keyword">const</span> messageIdsAtom = <span class="hljs-title function_">atom</span>({
  <span class="hljs-attr">key</span>: <span class="hljs-string">&quot;messageIds&quot;</span>,
  <span class="hljs-attr">effects</span>: [
    <span class="hljs-comment">/**
     * To be able to refetch in `graphQLSubscriptionEffect()`,
     * a `graphQLQueryEffect()` must first be created in the same recoil state.
     */</span>
    <span class="hljs-title function_">graphQLSubscriptionEffect</span>({
      <span class="hljs-attr">fetchPolicy</span>: <span class="hljs-string">&quot;no-cache&quot;</span>,
      <span class="hljs-attr">subscription</span>: <span class="hljs-title class_">TypeDefs</span>.<span class="hljs-property">onNewMessages</span>,
      <span class="hljs-attr">effect</span>: <span class="hljs-function">(<span class="hljs-params">{ refetch }</span>) =&gt;</span> {
        <span class="hljs-title function_">refetch</span>();
      },
    }),
  ],
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> messageIdsAtom;

</code></pre>
